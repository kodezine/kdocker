{
    "name": "STM32 Development Environment (On-Demand Tools)",
    "image": "stm32-dev-minimal:latest",
    
    // Run as kdev user (UID 1000)
    "remoteUser": "kdev",
    "containerUser": "kdev",
    
    // Mount project files to kdev's workspace
    "workspaceFolder": "/home/kdev/workspaces/project",
    "mounts": [
        "source=${localWorkspaceFolder},target=/home/kdev/workspaces/project,type=bind,consistency=cached",
        "source=${localEnv:HOME}/.ssh,target=/home/kdev/.ssh,type=bind,consistency=cached,readonly"
    ],
    
    // Forward ports for debugging
    "forwardPorts": [3333, 4444, 8080],
    
    "customizations": {
        "vscode": {
            "extensions": [
                // C/C++ Development
                "ms-vscode.cpptools",
                "ms-vscode.cpptools-extension-pack",
                "ms-vscode.cmake-tools",
                "twxs.cmake",
                
                // Embedded Development
                "marus25.cortex-debug",
                "dan-c-underwood.arm",
                "ms-vscode.vscode-serial-monitor",
                
                // Build & Debug
                "webfreak.debug",
                "ms-vscode.makefile-tools",
                
                // General Development
                "ms-python.python",
                "ms-python.vscode-pylance", 
                "eamodio.gitlens"
            ],
            "settings": {
                "terminal.integrated.defaultProfile.linux": "zsh",
                
                // C/C++ Configuration (will work when toolchain is installed)
                "C_Cpp.default.compilerPath": "/home/kdev/gnuarm14.3/bin/arm-none-eabi-gcc",
                "C_Cpp.default.cStandard": "c11",
                "C_Cpp.default.cppStandard": "c++17", 
                "C_Cpp.default.includePath": [
                    "${workspaceFolder}/src/**",
                    "${workspaceFolder}/include/**",
                    "/home/kdev/gnuarm14.3/arm-none-eabi/include/**"
                ],
                "C_Cpp.default.defines": [
                    "STM32F4XX",
                    "USE_HAL_DRIVER"
                ],
                
                // CMake Configuration
                "cmake.configureOnOpen": true,
                "cmake.generator": "Unix Makefiles",
                
                // Cortex Debug Configuration
                "cortex-debug.armToolchainPath": "/home/kdev/gnuarm14.3/bin",
                "cortex-debug.openocdPath": "/usr/bin/openocd",
                
                // General Settings
                "python.defaultInterpreterPath": "/usr/bin/python3",
                "files.eol": "\n"
            }
        }
    },
    
    // Setup commands after container creation
    "postCreateCommand": [
        "git config --global --add safe.directory /home/kdev/workspaces/project",
        "git config --global core.autocrlf input",
        "echo 'ðŸš€ STM32 Development Environment Ready!'",
        "echo 'ðŸ“‹ Check tool status: stm32-tools status'", 
        "echo 'ðŸ”§ Install GNU Arm: stm32-tools gnuarm'",
        "echo 'âš¡ Install everything: stm32-tools all'"
    ],
    
    // Keep container running
    "shutdownAction": "stopContainer",
    
    // Hardware access for ST-Link and USB devices
    "runArgs": [
        "--privileged", 
        "--device=/dev:/dev"
    ],
    
    // Environment variables
    "containerEnv": {
        "DISPLAY": "${localEnv:DISPLAY}",
        "WORKSPACE_ROOT": "/home/kdev/workspaces/project"
    }
}